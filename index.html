<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ARAM Progress Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  :root { --gap: 20px; --maxw: 980px; }
  body { font-family: system-ui, sans-serif; margin: 0; background:#fafafa; }
  .container { max-width: var(--maxw); margin: 24px auto 80px auto; padding: 0 16px; text-align: center; }
  h1 { margin: 0 0 8px 0; }
  h2 { margin: 28px 0 8px 0; }
  .section { margin: 24px 0; padding: 16px; border: 1px solid #e5e7eb; border-radius: 12px; background:#fff; }
  .muted { color: #6b7280; font-size: 13px; }
  .grid { display: grid; gap: var(--gap); }
  .grid-2x5 { grid-template-columns: repeat(2, minmax(0,1fr)); }
  @media(min-width:800px){ .grid-2x5{ grid-template-columns: repeat(5, minmax(0,1fr)); } }
  .card { position: relative; padding: 14px; border:1px solid #e5e7eb; border-radius: 12px; background:#fff; }
  .card h3 { margin: 0 0 6px 0; font-size: 16px; }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; font-size:12px; margin-left:8px; }
  canvas { max-width: 900px; margin: 0 auto; }
  /* Loading modal */
  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 9999; }
  .modal { background:#fff; padding: 24px 28px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  .spinner { width: 28px; height: 28px; border: 3px solid #e5e7eb; border-top-color: #111827; border-radius: 50%; animation: spin 1s linear infinite; display:inline-block; vertical-align: middle; margin-right:8px;}
  @keyframes spin { to { transform: rotate(360deg);} }
  /* Medals */
  .medal { position:absolute; top:8px; left:8px; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:12px; }
  .gold   { background: radial-gradient(circle at 30% 30%, #ffe88a, #e6b800); }
  .silver { background: radial-gradient(circle at 30% 30%, #f2f2f2, #bfbfbf); color:#111; }
  .bronze { background: radial-gradient(circle at 30% 30%, #ffd3a6, #b87333); }
  .gold-bg   { background: linear-gradient(180deg, #fff9e6, #fff5cc); }
  .silver-bg { background: linear-gradient(180deg, #f8f8f8, #efefef); }
  .bronze-bg { background: linear-gradient(180deg, #fff1e6, #ffe5d1); }
  /* Share cards */
  .share-cards { display:grid; gap: var(--gap); grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
  .share-card { border:1px solid #e5e7eb; border-radius:16px; padding:16px; background:linear-gradient(180deg,#ffffff,#fafafa); }
  .share-card h3 { margin:0 0 6px 0; }
</style>
</head>
<body>
<div id="loading" class="modal-backdrop">
  <div class="modal">
    <span class="spinner"></span><strong>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦</strong>
    <div class="muted">åˆå›ã¯æ•°ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</div>
  </div>
</div>

<div class="container">
  <header class="section">
    <h1>ARAM Progress</h1>
    <div id="summary" class="muted">Loadingâ€¦</div>
  </header>

  <section class="section">
    <h2>ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³æ¶ˆåŒ–ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>
    <div class="muted">æ¨ªè»¸ï¼šStartTimeï¼ˆé€šå¸¸ã¯HH:mmã€æ—¥ä»˜åˆ‡æ›¿ç‚¹ã¯MM-dd HH:mmï¼‰ / ç¸¦è»¸ï¼šãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ç´¯ç©%</div>
    <canvas id="progress"></canvas>
  </section>

  <section class="section">
    <h2>é »å‡ºãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ä¸Šä½10ä½“</h2>
    <div id="topChampsCards" class="grid grid-2x5"></div>
  </section>

  <section class="section">
    <h2>å‹ç‡ã®é«˜ã„/ä½ã„ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ï¼ˆå„5ä½“ï¼‰<span class="pill">n â‰¥ 3</span></h2>
    <div class="grid" style="grid-template-columns:1fr; gap:20px;">
      <div>
        <h3>é«˜ã„ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³</h3>
        <div id="champHigh" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));"></div>
      </div>
      <div>
        <h3>ä½ã„ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³</h3>
        <div id="champLow"  class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));"></div>
      </div>
    </div>
  </section>

  <section class="section">
    <h2>å‹ç‡ã®é«˜ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ <span class="pill">n â‰¥ 5</span></h2>
    <div id="userHigh" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));"></div>
  </section>

  <section class="section">
    <h2>å‚åŠ å›æ•°ã®å¤šã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ ä¸Šä½5äºº <span class="pill">é™¤å¤–: ãƒãƒ¬ã‚¹ãƒ­ã‚¢ãƒ³ / é‡è‰¯</span></h2>
    <div id="mostActive" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));"></div>
  </section>

  <section class="section">
    <h2>é”æˆã«æœ€ã‚‚è²¢çŒ®ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ ä¸Šä½5äºº</h2>
    <div class="muted">æœªä½¿ç”¨ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ã‚’åˆã‚ã¦ä½¿ç”¨æ¸ˆã¿ã«ã—ãŸå›æ•°ï¼ˆæ™‚ç³»åˆ—ã§åˆ¤å®šï¼‰</div>
    <div id="mostContrib" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));"></div>
  </section>

  <section class="section">
    <h2>å…±æœ‰ã‚«ãƒ¼ãƒ‰ï¼ˆXå‘ã‘ã¾ã¨ã‚ï¼‰</h2>
    <div style="margin:8px 0;">
      <button onclick="saveAllCards()">PNGã§ä¿å­˜</button>
      <button onclick="copyTopSummary()">ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
    <div id="shareCards" class="share-cards"></div>
  </section>
</div>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxaWtw0J8sHbB14_TzAWxFnMnimt-tERRThff5cCn8e8DQIwLbm8pIPneomrHsDAAfS/exec";
const MIN_GAMES_CHAMP = 3;
const MIN_GAMES_USER  = 5;
const EXCLUDE_USERS_FOR_ACTIVE = new Set(["ãƒãƒ¬ã‚¹ãƒ­ã‚¢ãƒ³","é‡è‰¯"]);
// å‹æ•—ä»®å®šï¼š1â€“5=Blue, 6â€“10=Red
function assumedTeam(slot){ return slot <= 5 ? "Blue" : "Red"; }

function showLoading(s){ document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
function formatPct(x){ return (Math.round(x*1000)/10).toFixed(1) + "%"; }

async function fetchData(){
  showLoading(true);
  const [matchesRes, refsRes] = await Promise.all([
    fetch(APPS_SCRIPT_URL + "?type=matches", { cache: "no-store" }),
    fetch(APPS_SCRIPT_URL + "?type=refs", { cache: "no-store" })
  ]);
  const matches = await matchesRes.json();
  const refs = await refsRes.json();
  showLoading(false);
  if(!matches.ok) throw new Error(matches.error || "matches error");
  return { rows: matches.data, users: refs.users || [], champions: refs.champions || [] };
}

function sortByTime(rows){
  return rows.slice().sort((a,b)=> String(a.startTime).localeCompare(String(b.startTime)));
}

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼šãƒ©ãƒ™ãƒ«ã¯åŸºæœ¬HH:mmã€æ—¥ä»˜åˆ‡æ›¿ç‚¹ã®ã¿MM-dd HH:mm
function buildTimelineLabels(sortedRows){
  const labels = [];
  let prevDay = "";
  for(const r of sortedRows){
    const s = String(r.startTime || ""); // "MM-dd HH:mm"
    const day = s.slice(0,5);            // "MM-dd"
    const hm  = s.slice(6);              // "HH:mm"
    if(labels.length === 0 || day !== prevDay){
      labels.push(s); // åˆå›ã¨æ—¥ä»˜åˆ‡æ›¿ç‚¹ã¯MM-dd HH:mm
      prevDay = day;
    } else {
      labels.push(hm); // ãã‚Œä»¥å¤–ã¯HH:mmã®ã¿
    }
  }
  return labels;
}

function calcProgress(rows, totalChampions){
  const sorted = sortByTime(rows);
  const seen = new Set();
  const y=[];
  for(const r of sorted){
    if(r.champion) seen.add(r.champion);
    y.push(Math.round(seen.size/totalChampions*100));
  }
  return { labels: buildTimelineLabels(sorted), y, uniqueCount: seen.size };
}

function topNChampions(rows, n=10){
  const freq = new Map();
  for(const r of rows) if(r.champion) freq.set(r.champion, (freq.get(r.champion)||0)+1);
  return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n).map(([k,v])=>({champion:k, count:v}));
}

function summarizeWins(rows, keyFn){
  const by = new Map();
  for(const r of rows){
    const k = keyFn(r);
    if(!k) continue;
    const team = assumedTeam(r.slot);
    const win = (r.winTeam === team) ? 1 : 0;
    const cur = by.get(k) || { w:0, n:0 };
    cur.w += win; cur.n += 1;
    by.set(k, cur);
  }
  return by;
}

function toSortedArray(byMap, {minN=1, take=10, comparator=(a,b)=> (b.rate - a.rate)}={}){
  const arr = [...byMap.entries()]
    .map(([name,{w,n}]) => ({ name, w, n, rate: n>0 ? w/n : 0 }))
    .filter(x => x.n >= minN)
    .sort(comparator)
    .slice(0, take);
  return arr;
}

/* ---------- Renderers ---------- */
function renderSummary(progress, total){
  document.getElementById('summary').textContent =
    `Unique champions: ${progress.uniqueCount}/${total} (${Math.round(progress.uniqueCount/total*100)}%)`;
}

function renderProgressChart(progress){
  new Chart(document.getElementById('progress'), {
    type: 'line',
    data: { labels: progress.labels, datasets: [{ label: 'é”æˆç‡(%)', data: progress.y }] },
    options: {
      responsive:true,
      scales:{
        y:{ min:0, max:100, ticks:{ stepSize:50, callback:(v)=> v + '%' } },
      }
    }
  });
}

function mountCards(elId, rows, mapper){
  const el = document.getElementById(elId);
  el.innerHTML = "";
  rows.forEach((r, idx) => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = mapper(r, idx);
    el.appendChild(div);
  });
}

// é »å‡ºãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ã‚’ã‚«ãƒ¼ãƒ‰åŒ–ï¼ˆ2x5ï¼‰
function renderTopChampsCards(items){
  mountCards('topChampsCards', items, (r)=> `
    <h3>${r.champion}</h3>
    <div class="muted">å‡ºç¾ ${r.count} å›</div>
  `);
}

// ãƒ¡ãƒ€ãƒ«è£…é£¾ï¼ˆä¸Šä½3ï¼‰
function medalizeCard(dom, rank){
  const span = document.createElement('div');
  span.className = 'medal ' + (rank===0?'gold':rank===1?'silver':'bronze');
  span.textContent = rank===0?'1':rank===1?'2':'3';
  dom.prepend(span);
  dom.classList.add(rank===0?'gold-bg':rank===1?'silver-bg':'bronze-bg');
}

/* å…±æœ‰ã‚«ãƒ¼ãƒ‰ */
function buildShareCards({topFreq, topContrib, topWinChamp, topWinUsers}){
  const host = document.getElementById('shareCards');
  host.innerHTML = "";
  const mk = (title, lines) => {
    const d = document.createElement('div');
    d.className = 'share-card';
    d.innerHTML = `<h3>${title}</h3><div>${lines.map(x=>`<div>${x}</div>`).join('')}</div>`;
    host.appendChild(d);
    return d;
  };
  const c1 = mk("ğŸ† å‹ç‡ãƒˆãƒƒãƒ—ãƒ»ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³", [
    topWinChamp[0] ? `${topWinChamp[0].name} / ${formatPct(topWinChamp[0].rate)} / n=${topWinChamp[0].n}` : '-'
  ]);
  const c2 = mk("ğŸ”¥ å‹ç‡ãƒˆãƒƒãƒ—ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆTop3ï¼‰",
    topWinUsers.slice(0,3).map(u=>`${u.name} / ${formatPct(u.rate)} / n=${u.n}`));
  const c3 = mk("ğŸ“ˆ æœ€å¤šå‡ºå ´ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³", [ topFreq[0] ? `${topFreq[0].champion}ï¼ˆ${topFreq[0].count}å›ï¼‰` : '-' ]);
  const c4 = mk("âœ¨ é”æˆã«æœ€ã‚‚è²¢çŒ®", [ topContrib[0] ? `${topContrib[0].user} / ${topContrib[0].count}å›` : '-' ]);
  return [c1,c2,c3,c4];
}

async function saveAllCards(){
  const nodes = Array.from(document.querySelectorAll('.share-card'));
  for (const n of nodes){
    const canvas = await html2canvas(n, {backgroundColor: '#ffffff', scale: 2});
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = `share_${Date.now()}.png`;
    a.click();
  }
}
function copyTopSummary(){
  const cards = document.querySelectorAll('.share-card');
  const text = Array.from(cards).map(c=>c.innerText).join('\n\n');
  navigator.clipboard.writeText(text);
  alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
}

/* ---------- Main ---------- */
fetchData().then(({rows, champions})=>{
  const totalChampions = champions.length > 0 ? champions.length : 171;

  // 1) ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
  const progress = calcProgress(rows, totalChampions);
  renderSummary(progress, totalChampions);
  renderProgressChart(progress);

  // 2) é »å‡ºãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰
  const freq = topNChampions(rows, 10);
  renderTopChampsCards(freq);

  // 3) å‹ç‡ï¼ˆãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ nâ‰¥3ï¼‰
  const byChamp = summarizeWins(rows, r => r.champion);
  const champHigh = toSortedArray(byChamp, { minN: MIN_GAMES_CHAMP, take: 5, comparator:(a,b)=>b.rate-a.rate });
  const champLow  = toSortedArray(byChamp, { minN: MIN_GAMES_CHAMP, take: 5, comparator:(a,b)=>a.rate-b.rate });
  mountCards('champHigh', champHigh, (r)=> `<h3>${r.name}</h3><div>å‹ç‡ ${formatPct(r.rate)} <span class="muted">n=${r.n}, w=${r.w}</span></div>`);
  mountCards('champLow',  champLow,  (r)=> `<h3>${r.name}</h3><div>å‹ç‡ ${formatPct(r.rate)} <span class="muted">n=${r.n}, w=${r.w}</span></div>`);

  // 4) å‹ç‡ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ nâ‰¥5ï¼‰ï¼‹ãƒ¡ãƒ€ãƒ«
  const byUser = summarizeWins(rows, r => r.user);
  const userHigh = toSortedArray(byUser, { minN: MIN_GAMES_USER, take: 10, comparator:(a,b)=>b.rate-a.rate });
  mountCards('userHigh', userHigh, (r)=> `<h3>${r.name}</h3><div>å‹ç‡ ${formatPct(r.rate)} <span class="muted">n=${r.n}, w=${r.w}</span></div>`);
  // ãƒ¡ãƒ€ãƒ«é©ç”¨ï¼ˆä¸Šä½3ï¼‰
  Array.from(document.querySelectorAll('#userHigh .card')).slice(0,3).forEach((el, i)=> medalizeCard(el, i));

  // 5) å‚åŠ å›æ•°ï¼ˆé™¤å¤–ã¤ãï¼‰ï¼‹ãƒ¡ãƒ€ãƒ«
  const activeMap = new Map();
  for(const r of rows){
    if(!r.user || EXCLUDE_USERS_FOR_ACTIVE.has(r.user)) continue;
    activeMap.set(r.user, (activeMap.get(r.user)||0)+1);
  }
  const mostActive = [...activeMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([name,count])=>({name,count}));
  mountCards('mostActive', mostActive, (r)=> `<h3>${r.name}</h3><div>å‚åŠ  ${r.count} å›</div>`);
  Array.from(document.querySelectorAll('#mostActive .card')).slice(0,3).forEach((el, i)=> medalizeCard(el, i));

  // 6) é”æˆè²¢çŒ®ï¼ˆåˆä½¿ç”¨ã‚«ã‚¦ãƒ³ãƒˆï¼‰ï¼‹ãƒ¡ãƒ€ãƒ«
  const seen = new Set(); const contribMap = new Map();
  for(const r of sortByTime(rows)){
    if(!r.champion) continue;
    if(!seen.has(r.champion)){
      seen.add(r.champion);
      const u = r.user || "(åç„¡ã—)";
      contribMap.set(u, (contribMap.get(u)||0)+1);
    }
  }
  const contrib = [...contribMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([user,count])=>({user,count}));
  mountCards('mostContrib', contrib, (r)=> `<h3>${r.user}</h3><div>åˆä½¿ç”¨ ${r.count} ä½“</div>`);
  Array.from(document.querySelectorAll('#mostContrib .card')).slice(0,3).forEach((el, i)=> medalizeCard(el, i));

  // 7) å…±æœ‰ã‚«ãƒ¼ãƒ‰
  buildShareCards({
    topFreq: freq,
    topContrib: contrib,
    topWinChamp: champHigh,
    topWinUsers: userHigh
  });

}).catch(err=>{
  showLoading(false);
  document.getElementById('summary').textContent = 'Error: ' + err.message;
});
</script>
</body>
</html>
