<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ARAM Progress Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  :root { --gap: 20px; --maxw: 1280px; --ink:#0f172a; --sub:#667085; --line:#e5e7eb; --card:#ffffff; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif; margin: 0; background:#fafafa; color:#111; }
  .container { max-width: var(--maxw); margin: 24px auto 80px auto; padding: 0 16px; text-align: center; }
  h1 { margin: 0 0 8px 0; }
  h2 { margin: 28px 0 8px 0; }
  .section { margin: 24px 0; padding: 16px; border: 1px solid var(--line); border-radius: 12px; background:var(--card); }
  .muted { color: #6b7280; font-size: 13px; }
  @media (min-width: 1024px) {
    .section {
      width: 66%;
      margin-left: auto;
      margin-right: auto;
    }
  }
  /* grid helpers */
  .col-2 { display:grid; grid-template-columns: 1fr; gap: var(--gap); text-align: left; }
  @media(min-width:860px){ .col-2{ grid-template-columns: 1fr 1fr; } }
  .colcol { display:flex; flex-direction:column; align-items:center; }
  .vlist { display:flex; flex-direction:column; gap:12px; align-items:center; }

  /* cards */
  .card { position: relative; padding: 14px; border:1px solid var(--line); border-radius: 12px; background:var(--card); text-align:left; width: min(420px, 33%); }
  #champLow .card, #champHigh .card { width: 100%; }
  @media(max-width:760px){ .card{ width:100%; } }
  .card .title { font-size:16px; font-weight:600; margin:0 0 6px 0; }
  .card.has-medal .title { padding-left: 40px; }
  .row { display:flex; gap:10px; align-items:center; }
  .champ-icon { width:28px; height:28px; border-radius:6px; object-fit:cover; background:#eee; }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; font-size:12px; margin-left:8px; }

  /* chart */
  .chart-wrap { position: relative; width: 100%; height: 420px; margin: 0 auto; }
  @media(min-width:1024px){ .chart-wrap{ height: 460px; width: 70%; margin: 0 auto; } }
  #progress { width: 100% !important; height: 100% !important; display:block; }

  /* loading modal */
  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 9999; }
  .modal { background:#fff; padding: 24px 28px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  .spinner { width: 28px; height: 28px; border: 3px solid #e5e7eb; border-top-color: #111827; border-radius: 50%; animation: spin 1s linear infinite; display:inline-block; vertical-align: middle; margin-right:8px;}
  @keyframes spin { to { transform: rotate(360deg);} }

  /* medals */
  .medal { position:absolute; top:8px; left:8px; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:12px; }
  .gold   { background: radial-gradient(circle at 30% 30%, #ffe88a, #e6b800); }
  .silver { background: radial-gradient(circle at 30% 30%, #f2f2f2, #bfbfbf); color:#111; }
  .bronze { background: radial-gradient(circle at 30% 30%, #ffd3a6, #b87333); }
  .gold-bg   { background: linear-gradient(180deg, #fff9e6, #fff5cc); }
  .silver-bg { background: linear-gradient(180deg, #f8f8f8, #efefef); }
  .bronze-bg { background: linear-gradient(180deg, #fff1e6, #ffe5d1); }

  /* ========== Result card (small, centered) ========== */
  .result-stage{ width:100%; display:flex; justify-content:center; }
  .rcanvas {
    width: 360px; height: 260px;
    background: #fdfdfd; border:1px solid var(--line); border-radius: 8px;
    position: relative; overflow:hidden; font-size:9px;
  }
  @media(max-width:560px){
    .rcanvas{ width:100%; height:auto; aspect-ratio:16/9; }
  }
  .rc-bg { background:
    radial-gradient(600px 300px at -10% 10%, #eef2ff 0%, transparent 60%),
    radial-gradient(400px 200px at 110% 90%, #fef3c7 0%, transparent 55%),
    radial-gradient(800px 500px at 50% 45%, rgba(0,0,0,0.035) 0%, transparent 70%),
    linear-gradient(180deg,#ffffff, #f8fafc 75%),
    linear-gradient(180deg, #f7f7f7 0%, #f1f1f1 100%);
  }
  .rc-topbar { position:absolute; top:0; left:0; right:0; height:32px; background:#0b1736; color:#fff; display:flex; align-items:center; padding:0 10px; }
  .rc-topbar .brand { font-weight:700; letter-spacing:0.08em; font-size:10px; opacity:.65; }
  .rc-topbar .result { margin-left:6px; font-weight:800; font-size:12px; }
  .rc-body { position:absolute; inset:32px 0 0 0; display:grid; grid-template-columns: 1.2fr 0.5fr; height: calc(100% - 32px); }
  .rc-left { padding:8px 10px; display:grid; grid-template-rows:auto auto auto; gap:6px; }
  .rc-right{
    position:relative;
    display:flex;
    flex-direction:column;
    align-items:center;     /* 横センター */
    justify-content:flex-start; /* 縦センター */
    padding:8px;
  }
  .rc-info { display:grid; grid-template-columns: 1fr 1fr; gap:6px; }
  .rc-card { border:1px solid var(--line); background:#fff; border-radius:6px; padding:4px 6px; text-align:left; }
  .rc-kv { display:flex; align-items:baseline; gap:4px; }
  .rc-kv .k { color: var(--sub); font-size:8px; }
  .rc-kv .v { font-weight:800; font-size:12px; color: var(--ink); letter-spacing:.03em; }

  /* リスト表示（枠線なし・箇条書き記号） */
  .rc-list { display:flex; flex-direction:column; gap:2px; }
  .rc-chip { border:none; background:transparent; padding:0; min-height:auto; display:flex; align-items:center; }
  .rc-chip .name::before { content:"• "; color:#111; }
  .rc-chip .name { font-weight:600; font-size:9px; color:#111; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .rc-avatars { display:flex; gap:6px; flex-wrap:wrap; }
  .rc-avatars img { width:28px; height:28px; border-radius:4px; object-fit:cover; background:#eee; border:1px solid #d1d5db; }

  /* キャラクター：カード高さの70%で上側配置 + キャプション */
  .rc-char{
    position:static;        /* ← absolute を削除 */
    height:80%;             /* カード高の約7割 */
    width:auto;
    image-rendering: pixelated;
    filter: drop-shadow(0 6px 18px rgba(0,0,0,.25));
    max-width:100%;
    max-height:90%;
  }
  .rc-caption{
    position:static;        /* ← absolute を削除 */
    margin-top:6px;
    text-align:center;
    font-weight:700;
    color:#0b1736;
    line-height:1.05;
  }
  .rc-caption .small{ font-size:10px; opacity:.8; }
</style>
</head>
<body>
<div id="loading" class="modal-backdrop">
  <div class="modal">
    <span class="spinner"></span><strong>データを読み込み中…</strong>
    <div class="muted">初回は数秒かかる場合があります。</div>
  </div>
</div>

<div class="container">
  <header class="section">
    <h1>ARAM Progress</h1>
    <div id="summary" class="muted">Loading…</div>
  </header>

  <section class="section">
    <h2>進捗タイムライン</h2>
    <div class="muted">横軸：時間 / 縦軸：達成度</div>
    <div class="chart-wrap"><canvas id="progress"></canvas></div>
  </section>

  <section class="section">
    <h2>頻出チャンピオン</h2>
    <div id="topChampsCards" class="vlist"></div>
  </section>

  <section class="section">
    <h2>勝率の低い/高いチャンピオン<span class="pill">n ≥ 3</span></h2>
    <div class="col-2">
      <div class="colcol">
        <h3 style="margin:0 0 10px 0;">勝率ワースト5</h3>
        <div id="champLow"  class="vlist"></div>
      </div>
      <div class="colcol">
        <h3 style="margin:0 0 10px 0;">勝率トップ5</h3>
        <div id="champHigh" class="vlist"></div>
      </div>
    </div>
  </section>

  <section class="section">
    <h2>勝率の高いユーザー <span class="pill">n ≥ 5</span></h2>
    <div id="userHigh" class="vlist"></div>
  </section>

  <section class="section">
    <h2>参加回数の多いリスナー 上位5人 <span class="pill" id="malNote">総ゲーム数 = 0</span></h2>
    <div id="mostActive" class="vlist"></div>
  </section>

  <section class="section">
    <h2>最も貢献したリスナー 上位5人 <span class="pill" id="malContrib">マレスロアン = 0</span></h2>
    <div class="muted">未使用チャンピオンを初めて使用した回数</div>
    <div id="mostContrib" class="vlist"></div>
  </section>

  <!-- ===== Result card section ===== -->
  <section class="section">
    <div class="result-wrap">
      <div class="result-stage">
        <div id="resultCard" class="rcanvas" aria-label="Result Card">
          <div class="rc-bg"></div>
          <div class="rc-topbar">
            <div class="brand">ARAM RECORD</div>
            <div class="result">RESULT</div>
          </div>
          <div class="rc-body">
            <div class="rc-left">
              <div class="rc-info">
                <div class="rc-card">
                  <div class="rc-kv"><div class="k">TIME</div><div id="rc-time" class="v">00H00M</div></div>
                </div>
                <div class="rc-card">
                  <div class="rc-kv"><div class="k">PROGRESS</div><div id="rc-progress" class="v">0/171</div></div>
                </div>
              </div>
              <div class="rc-card">
                <div class="rc-kv" style="margin-bottom:4px;">
                  <div class="k">POPULAR CHAMPION</div><div class="v" style="font-size:10px;">Top 5</div>
                </div>
                <div id="rc-popular" class="rc-avatars"></div>
              </div>
              <div class="rc-info">
                <div class="rc-card">
                  <div class="rc-kv" style="margin-bottom:4px;">
                    <div class="k">MOST JOINED</div><div class="v" style="font-size:10px;">Top 5</div>
                  </div>
                  <div id="rc-part" class="rc-list"></div>
                </div>
                <div class="rc-card">
                  <div class="rc-kv" style="margin-bottom:4px;">
                    <div class="k">MOST CONTRIB</div><div class="v" style="font-size:10px;">Top 5</div>
                  </div>
                  <div id="rc-contrib" class="rc-list"></div>
                </div>
              </div>
            </div>
            <div class="rc-right">
              <img id="rc-char" class="rc-char" src="mares.png" alt="Maresroan" />
              <div class="rc-caption">
                <div class="small">thank you</div>
                <div class="small">for watching</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
/* ====== Config ====== */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxaWtw0J8sHbB14_TzAWxFnMnimt-tERRThff5cCn8e8DQIwLbm8pIPneomrHsDAAfS/exec";
const MIN_GAMES_CHAMP = 3;
const MIN_GAMES_USER  = 5;
const EXCLUDE_FOR_ACTIVE = new Set(["マレスロアン","野良"]);
const MAX_TICKS = 10;
const RESULT_CHAR_URL = ""; // 任意差し替え

/* ====== Helpers ====== */
function assumedTeam(slot){ return slot <= 5 ? "Blue" : "Red"; }
function showLoading(s){ document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
function fmt2(n){ return String(n).padStart(2,'0'); }
function formatPct(x){ return (Math.round(x*1000)/10).toFixed(1) + "%"; }

/* ====== Data Dragon ====== */
let DD_VER = null;
let CHAMP_IMG_BY_JA = new Map();
async function loadDataDragon(){
  try{
    const vers = await (await fetch('https://ddragon.leagueoflegends.com/api/versions.json')).json();
    DD_VER = vers[0];
    const data = await (await fetch(`https://ddragon.leagueoflegends.com/cdn/${DD_VER}/data/ja_JP/champion.json`)).json();
    for(const key in data.data){
      const obj = data.data[key];
      CHAMP_IMG_BY_JA.set(obj.name, `https://ddragon.leagueoflegends.com/cdn/${DD_VER}/img/champion/${obj.image.full}`);
    }
  }catch(e){ console.warn('Data Dragon load failed', e); }
}
function champIconUrl(japaneseName){ return CHAMP_IMG_BY_JA.get(japaneseName) || ''; }

/* ====== Fetch ====== */
async function fetchData(){
  showLoading(true);
  const [matchesRes, refsRes] = await Promise.all([
    fetch(APPS_SCRIPT_URL + "?type=matches", { cache: "no-store" }),
    fetch(APPS_SCRIPT_URL + "?type=refs", { cache: "no-store" }),
    loadDataDragon()
  ]);
  const matches = await matchesRes.json();
  const refs = await refsRes.json();
  showLoading(false);
  if(!matches.ok) throw new Error(matches.error || "matches error");
  return { rows: matches.data, users: refs.users || [], champions: refs.champions || [] };
}

/* ====== Time utils ====== */
function parseMDHM(s){
  const m = String(s).match(/^(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/);
  if (!m) return new Date(NaN);
  const [, MM, DD, HH, mm] = m;
  return new Date(Date.UTC(2000, Number(MM)-1, Number(DD), Number(HH), Number(mm)));
}
function rowsWithDates(rows){
  return rows.map(r => ({ ...r, _date: parseMDHM(r.startTime) }))
             .filter(r => !isNaN(r._date));
}
function sortByTime(rows){ return rows.slice().sort((a,b)=> a._date - b._date); }

/* ====== Progress（試合単位） ====== */
function calcProgressByMatch(sortedRows, totalChampions){
  const matches = [];
  let cur = null;
  for (const r of sortedRows){
    if (!cur || r.matchId !== cur.matchId){
      if (cur) matches.push(cur);
      cur = { matchId: r.matchId, timeMs: r._date.getTime(), champions: new Set() };
    }
    if (r.champion) cur.champions.add(r.champion);
  }
  if (cur) matches.push(cur);

  const seen = new Set(); const times = []; const y = [];
  for (const m of matches){
    for (const c of m.champions){ if (!seen.has(c)) seen.add(c); }
    times.push(m.timeMs);
    y.push(Math.round(seen.size / totalChampions * 100));
  }
  return { times, y, uniqueCount: seen.size, firstMs: matches[0]?.timeMs ?? null, lastMs: matches[matches.length-1]?.timeMs ?? null };
}

/* ====== X ticks (max ~6) ====== */
function buildDesiredTicks(times){
  if(times.length === 0) return [];
  const first = times[0], last = times[times.length-1];
  if (first === last) return [first];
  const ticks = [first, last];
  const need = Math.max(0, MAX_TICKS - ticks.length);
  for(let i=1;i<=need;i++){
    const t = first + Math.round((last - first) * (i/(need+1)));
    ticks.push(t);
  }
  return Array.from(new Set(ticks)).sort((a,b)=>a-b).slice(0, MAX_TICKS);
}

/* ====== Aggregations ====== */
function topNChampions(rows, n=5){
  const freq = new Map();
  for(const r of rows) if(r.champion) freq.set(r.champion, (freq.get(r.champion)||0)+1);
  return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n).map(([k,v])=>({champion:k, count:v}));
}
function summarizeWins(rows, keyFn){
  const by = new Map();
  for(const r of rows){
    const k = keyFn(r); if(!k) continue;
    const team = assumedTeam(r.slot);
    const win = (r.winTeam === team) ? 1 : 0;
    const cur = by.get(k) || { w:0, n:0 };
    cur.w += win; cur.n += 1;
    by.set(k, cur);
  }
  return by;
}
function cmpHigh(a,b){ if (b.rate !== a.rate) return b.rate - a.rate; if (b.n !== a.n) return b.n - a.n; return a.name.localeCompare(b.name,'ja'); }
function cmpLow (a,b){ if (a.rate !== b.rate) return a.rate - b.rate; if (b.n !== a.n) return b.n - a.n; return a.name.localeCompare(b.name,'ja'); }
function toSortedArray(byMap, {minN=1, take=10, comparator=(a,b)=> (b.rate - a.rate)}={}){
  return [...byMap.entries()].map(([name,{w,n}]) => ({ name, w, n, rate: n>0 ? w/n : 0 }))
    .filter(x => x.n >= minN).sort(comparator).slice(0, take);
}

/* ====== Render: summary ====== */
function renderSummary(progress, total){
  document.getElementById('summary').textContent =
    `Unique champions: ${progress.uniqueCount}/${total} (${Math.round(progress.uniqueCount/total*100)}%)`;
}

/* ====== Render: chart ====== */
let progressChart = null;
function renderProgressChart(progress){
  const ctx = document.getElementById('progress').getContext('2d');
  if (progressChart) progressChart.destroy();

  const ticks = buildDesiredTicks(progress.times);
  const xMin = ticks[0], xMax = ticks[ticks.length-1];

  progressChart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [{
        label: '達成率(%)',
        data: progress.times.map((t,i)=> ({ x: t, y: progress.y[i] })),
        tension: 0,
        pointRadius: 0,
        borderWidth: 2,
        spanGaps: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      parsing: false,
      scales: {
        x: {
          type: 'time',
          bounds: 'ticks',
          min: xMin, max: xMax,
          afterBuildTicks: (scale) => { scale.ticks = ticks.map(v => ({ value: v })); },
          ticks: {
            autoSkip: false, maxRotation: 0,
            callback: (value) => {
              const d = new Date(Number(value));
              const HH = fmt2(d.getUTCHours());
              const DD = fmt2(d.getUTCDate());
              return (value === xMin) ? `${DD}日/${HH}時` : `${HH}`;
            }
          }
        },
        y: { min: 0, max: 100, ticks: { stepSize: 10, callback: v => v + '%' } }
      }
    }
  });
}

/* ====== Render helpers ====== */
function mountVList(elId, rows, mapper){
  const el = document.getElementById(elId);
  el.innerHTML = "";
  rows.forEach((r, idx) => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = mapper(r, idx);
    el.appendChild(div);
  });
}
function medalizeTop3(containerSelector){
  const cards = Array.from(document.querySelectorAll(containerSelector + ' .card')).slice(0,3);
  cards.forEach((el, i)=>{
    const m = document.createElement('div');
    m.className = 'medal ' + (i===0?'gold':i===1?'silver':'bronze');
    m.textContent = (i+1).toString();
    el.prepend(m);
    el.classList.add(i===0?'gold-bg':i===1?'silver-bg':'bronze-bg','has-medal');
  });
}

/* ====== Result card ====== */
function formatDurationHM(msStart, msEnd){
  if(msStart==null || msEnd==null) return "00H00M";
  const diff = Math.max(0, msEnd - msStart);
  const m = Math.round(diff / 60000);
  const h = Math.floor(m / 60);
  const mm = fmt2(m % 60);
  return `${fmt2(h)}H${mm}M`;        // ← 時を2桁で表示
}
function fillResultCard({durationHM, progressText, popularN, partTopN, contribTopN, charUrl}){
  document.getElementById('rc-time').textContent = durationHM;
  document.getElementById('rc-progress').textContent = progressText;

  const popEl = document.getElementById('rc-popular'); popEl.innerHTML = "";
  popularN.forEach(p=>{
    const img = document.createElement('img');
    img.src = p.iconUrl || ''; img.alt = ''; img.loading = 'lazy';
    popEl.appendChild(img);
  });

  const mkNameList = (id, list) => {
    const el = document.getElementById(id); el.innerHTML = "";
    list.forEach(n=>{
      const chip = document.createElement('div'); chip.className = 'rc-chip';
      chip.innerHTML = `<div class="name">${n}</div>`;
      el.appendChild(chip);
    });
  };
  mkNameList('rc-part', partTopN);
  mkNameList('rc-contrib', contribTopN);

  if (charUrl){ document.getElementById('rc-char').src = charUrl; }
}
async function renderResultImage(){
  const node = document.getElementById('resultCard');
  const canvas = await html2canvas(node, {backgroundColor: null, scale: 2});
  document.getElementById('resultImage').src = canvas.toDataURL('image/png');
}

/* ====== Main ====== */
(async()=>{
  try{
    const {rows, champions} = await fetchData();
    const totalChampions = champions.length > 0 ? champions.length : 171;

    // timeline
    const rowsD = sortByTime(rowsWithDates(rows));
    const progress = calcProgressByMatch(rowsD, totalChampions);
    renderSummary(progress, totalChampions);
    renderProgressChart(progress);

    // 頻出チャンピオン（5件）
    const freq = topNChampions(rowsD, 5);
    const popular5 = freq.slice(0,5).map(f=>({ iconUrl: champIconUrl(f.champion) }));
    mountVList('topChampsCards', freq, (r)=> {
      const url = champIconUrl(r.champion);
      return `
        <div class="row">
          <img class="champ-icon" src="${url}" alt="" onerror="this.style.visibility='hidden'"/>
          <div>
            <div class="title">${r.champion}</div>
            <div class="muted">出現 ${r.count} 回</div>
          </div>
        </div>`;
    });

    // 勝率（チャンピオン n≥3）
    const byChamp = summarizeWins(rowsD, r => r.champion);
    const champHigh = toSortedArray(byChamp, { minN: MIN_GAMES_CHAMP, take: 5, comparator: cmpHigh });
    const champLow  = toSortedArray(byChamp, { minN: MIN_GAMES_CHAMP, take: 5, comparator: cmpLow  });
    mountVList('champHigh', champHigh, (r)=> {
      const url = champIconUrl(r.name);
      return `
        <div class="row">
          <img class="champ-icon" src="${url}" alt="" onerror="this.style.visibility='hidden'"/>
          <div>
            <div class="title">${r.name}</div>
            <div>勝率 ${formatPct(r.rate)} <span class="muted">n=${r.n}</span></div>
          </div>
        </div>`;
    });
    mountVList('champLow',  champLow,  (r)=> {
      const url = champIconUrl(r.name);
      return `
        <div class="row">
          <img class="champ-icon" src="${url}" alt="" onerror="this.style.visibility='hidden'"/>
          <div>
            <div class="title">${r.name}</div>
            <div>勝率 ${formatPct(r.rate)} <span class="muted">n=${r.n}</span></div>
          </div>
        </div>`;
    });

    // 勝率（ユーザー n≥5）
    const byUser = summarizeWins(rowsD, r => r.user);
    const userHigh = toSortedArray(byUser, { minN: MIN_GAMES_USER, take: 5, comparator: cmpHigh });
    mountVList('userHigh', userHigh, (r)=> `<div class="title">${r.name}</div><div>勝率 ${formatPct(r.rate)} <span class="muted">n=${r.n}</span></div>`);
    medalizeTop3('#userHigh');

    // 参加回数 Top5
    let malCount = 0;
    const activeMap = new Map();
    for(const r of rowsD){
      if(!r.user) continue;
      if(r.user === "マレスロアン") malCount++;
      if(EXCLUDE_FOR_ACTIVE.has(r.user)) continue;
      activeMap.set(r.user, (activeMap.get(r.user)||0)+1);
    }
    document.getElementById('malNote').textContent = `総ゲーム数 = ${malCount}`;
    const mostActiveTop5 = [...activeMap.entries()]
      .sort((a,b)=> (b[1]-a[1]) || a[0].localeCompare(b[0],'ja'))
      .slice(0,5)
      .map(([name,count])=>({name,count}));
    mountVList('mostActive', mostActiveTop5, (r)=> `<div class="title">${r.name}</div><div>参加 ${r.count} 回</div>`);
    medalizeTop3('#mostActive');

    // 初使用貢献 Top5
    const seenFirst = new Set(); const contribMap = new Map(); let malContrib = 0;
    for(const r of rowsD){
      if(!r.champion) continue;
      if(!seenFirst.has(r.champion)){
        seenFirst.add(r.champion);
        const u = r.user || "(名無し)";
        if(u === "マレスロアン"){ malContrib++; continue; }
        contribMap.set(u, (contribMap.get(u)||0)+1);
      }
    }
    document.getElementById('malContrib').textContent = `マレスロアン = ${malContrib}`;
    const contribTop5 = [...contribMap.entries()]
      .sort((a,b)=> (b[1]-a[1]) || a[0].localeCompare(b[0],'ja'))
      .slice(0,5).map(([user,count])=>({user,count}));
    mountVList('mostContrib', contribTop5, (r)=> `<div class="title">${r.user}</div><div>${r.count} 体 貢献</div>`);
    medalizeTop3('#mostContrib');

    /* ===== Result card (Top5) ===== */
    const durationHM = formatDurationHM(progress.firstMs, progress.lastMs);
    const progressText = `${progress.uniqueCount}/${totalChampions}`;
    const partTop5Names = mostActiveTop5.slice(0,5).map(x=>x.name);
    const contribTop5Names = contribTop5.slice(0,5).map(x=>x.user);
    fillResultCard({
      durationHM,
      progressText,
      popularN: popular5,
      partTopN: partTop5Names,
      contribTopN: contribTop5Names,
      charUrl: RESULT_CHAR_URL
    });
    await renderResultImage();

  }catch(err){
    showLoading(false);
    document.getElementById('summary').textContent = 'Error: ' + err.message;
  }
})();
</script>
</body>
</html>
