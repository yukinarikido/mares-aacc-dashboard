<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARAM Progress</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    .row { display: flex; gap: 24px; flex-wrap: wrap; }
    canvas { max-width: 560px; }
    .card { padding:16px; border:1px solid #ddd; border-radius:12px; margin-bottom:16px; }
  </style>
</head>
<body>
  <h1>ARAM Progress</h1>
  <div class="card"><p id="summary">Loading…</p></div>
  <div class="row">
    <div class="card"><canvas id="progress"></canvas></div>
    <div class="card"><canvas id="topChamps"></canvas></div>
  </div>

  <script>
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxaWtw0J8sHbB14_TzAWxFnMnimt-tERRThff5cCn8e8DQIwLbm8pIPneomrHsDAAfS/exec";

  async function fetchData() {
    const [matchesRes, refsRes] = await Promise.all([
      fetch(APPS_SCRIPT_URL + "?type=matches", { cache: "no-store" }),
      fetch(APPS_SCRIPT_URL + "?type=refs",    { cache: "no-store" }),
    ]);
    const matches = await matchesRes.json();
    const refs = await refsRes.json();
    if (!matches.ok) throw new Error(matches.error || "matches error");
    return { matches: matches.data, users: refs.users || [], champions: refs.champions || [] };
  }

  function calcProgress(data, totalChampions) {
    // StartTime（"MM-dd HH:mm"）で昇順ソート → 累積ユニーク
    const sorted = data.slice().sort((a,b)=>String(a.startTime).localeCompare(String(b.startTime)));
    const seen = new Set();
    const t = [], y = [];
    for (const rec of sorted) {
      if (rec.champion) seen.add(rec.champion);
      t.push(rec.startTime);
      y.push(Math.round((seen.size / totalChampions) * 100));
    }
    return { t, y, uniqueCount: seen.size };
  }

  function topNChampions(data, n=10) {
    const freq = new Map();
    for (const r of data) if (r.champion) freq.set(r.champion, (freq.get(r.champion) || 0) + 1);
    const arr = [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n);
    return { labels: arr.map(a=>a[0]), values: arr.map(a=>a[1]) };
  }

  function render(matches, champions) {
    const total = champions.length > 0 ? champions.length : 171;
    const prog = calcProgress(matches, total);
    const top = topNChampions(matches, 10);

    document.getElementById('summary').textContent =
      `Unique champions: ${prog.uniqueCount}/${total} (${Math.round(prog.uniqueCount/total*100)}%)`;

    new Chart(document.getElementById('progress').getContext('2d'), {
      type: 'line',
      data: { labels: prog.t, datasets: [{ label: '達成率(%)', data: prog.y }] },
      options: { responsive: true, scales: { y: { min:0, max:100 } } }
    });

    new Chart(document.getElementById('topChamps').getContext('2d'), {
      type: 'bar',
      data: { labels: top.labels, datasets: [{ label: '出現回数', data: top.values }] },
      options: { responsive: true }
    });
  }

  fetchData()
    .then(({matches, champions}) => render(matches, champions))
    .catch(err => { document.getElementById('summary').textContent = 'Error: ' + err.message; });
  </script>
</body>
</html>
